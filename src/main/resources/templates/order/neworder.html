<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>New Order</title>
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
</head>
<body>
<div class="container my-4">
    <h3>New Order</h3>

    <form th:action="@{/order/save}" th:object="${orderForm}" method="post">
        <div class="alert alert-danger" th:if="${#fields.hasAnyErrors()}">
            Please check the entered data.
        </div>
        <div class="form-row">
            <div class="form-group col-md-4">
                <label>Buyer</label>
                <select th:field="*{buyerId}" class="form-control" required>
                    <option value="">-- select --</option>
                    <option th:each="buyer : ${buyers}"
                            th:value="${buyer.buyerId}"
                            th:text="${buyer.firstName + ' ' + buyer.lastName}"></option>
                </select>
            </div>
            <div class="form-group col-md-4">
                <label>Payment method</label>
                <select th:field="*{paymentOption}" class="form-control" required>
                    <option value="">-- select --</option>
                    <option th:each="p : ${paymentOptions}" th:value="${p}" th:text="${p}"></option>
                </select>
            </div>
            <div class="form-group col-md-4">
                <label>Currency</label>
                <input type="text" th:field="*{currency}" class="form-control" placeholder="EUR" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group col-md-5">
                <label>City</label>
                <input type="text" th:field="*{city}" class="form-control" required>
            </div>
            <div class="form-group col-md-5">
                <label>Street</label>
                <input type="text" th:field="*{street}" class="form-control" required>
            </div>
            <div class="form-group col-md-2">
                <label>Number</label>
                <input type="text" th:field="*{homeNumber}" class="form-control">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group col-md-6">
                <label>Contact number</label>
                <input type="text" th:field="*{contactNumber}" class="form-control">
            </div>
            <div class="form-group col-md-6">
                <label>Note</label>
                <input type="text" th:field="*{note}" class="form-control">
            </div>
        </div>

        <hr>
        <h5>Items</h5>

        <table class="table table-bordered table-sm">
            <thead>
            <tr>
                <th>Name</th>
                <th>Quantity</th>
                <th>Price</th>
                <th style="width: 100px;"></th>
            </tr>
            </thead>
            <tbody id="itemsBody">
            <tr th:each="item,iter : ${orderForm.items}" class="item-row">
                <td>
                    <input type="text" class="form-control"
                           th:name="|items[${iter.index}].name|"
                           th:value="${item.name}" data-field="name" required>
                </td>
                <td>
                    <input type="number" min="1" class="form-control"
                           th:name="|items[${iter.index}].quantity|"
                           th:value="${item.quantity}" data-field="quantity" required>
                </td>
                <td>
                    <input type="number" min="0" step="0.01" class="form-control"
                           th:name="|items[${iter.index}].price|"
                           th:value="${item.price}" data-field="price" required>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-row">Remove</button>
                </td>
            </tr>

            <tr th:if="${#lists.isEmpty(orderForm.items)}" class="item-row">
                <td><input type="text" class="form-control" name="items[0].name" data-field="name" required></td>
                <td><input type="number" min="1" class="form-control" name="items[0].quantity" data-field="quantity" required></td>
                <td><input type="number" min="0" step="0.01" class="form-control" name="items[0].price" data-field="price" required></td>
                <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">Remove</button></td>
            </tr>
            </tbody>
        </table>

        <button type="button" id="addItemBtn" class="btn btn-outline-secondary btn-sm mb-3">Add Item</button>
        <br>
        <button type="submit" class="btn btn-primary">Save Order</button>
        <a th:href="@{/order/}" class="btn btn-link">Back</a>
    </form>
</div>

<script>
    (function () {
        const body = document.getElementById("itemsBody");
        const addBtn = document.getElementById("addItemBtn");

        function reindexRows() {
            const rows = body.querySelectorAll("tr.item-row");
            rows.forEach((row, index) => {
                row.querySelectorAll("input[data-field]").forEach((input) => {
                    const field = input.getAttribute("data-field");
                    input.name = `items[${index}].${field}`;
                });
            });
        }

        function addRow() {
            const row = document.createElement("tr");
            row.className = "item-row";
            row.innerHTML = `
                <td><input type="text" class="form-control" data-field="name" required></td>
                <td><input type="number" min="1" class="form-control" data-field="quantity" required></td>
                <td><input type="number" min="0" step="0.01" class="form-control" data-field="price" required></td>
                <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">Remove</button></td>
            `;
            body.appendChild(row);
            reindexRows();
        }

        body.addEventListener("click", function (event) {
            if (event.target.classList.contains("remove-row")) {
                const rows = body.querySelectorAll("tr.item-row");
                if (rows.length <= 1) {
                    return;
                }
                event.target.closest("tr").remove();
                reindexRows();
            }
        });

        addBtn.addEventListener("click", addRow);
        reindexRows();
    })();
</script>
</body>
</html>